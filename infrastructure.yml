AWSTemplateFormatVersion: "2010-09-09"
Description: Fullstack App Infrastructure

Resources:
  # VPC for your infrastructure
  SDNVPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: 172.31.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true

  # Internet Gateway for VPC
  SDNInternetGateway:
    Type: AWS::EC2::InternetGateway

  # Attach Internet Gateway to VPC
  SDNVPCGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref SDNVPC
      InternetGatewayId: !Ref SDNInternetGateway

  # Public subnet A for the application (eu-north-1a)
  SDNPublicSubnetA:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SDNVPC
      CidrBlock: 172.31.49.0/24
      AvailabilityZone: eu-north-1a

  # Public subnet B for the application (eu-north-1b)
  SDNPublicSubnetB:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref SDNVPC
      CidrBlock: 172.31.48.0/24
      AvailabilityZone: eu-north-1b

  # S3 bucket for static frontend hosting
  SDNBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub sdn-frontend-${AWS::AccountId}-${AWS::Region}
      Tags:
        - Key: Name
          Value: !Sub sdn-frontend-${AWS::AccountId}-${AWS::Region}

  # EC2 instance for backend deployment
  SDNEC2Instance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: t3.micro
      ImageId: ami-09278528675a8d54e
      KeyName: ec2Key
      SecurityGroupIds:
        - !Ref SDNSecurityGroup
      SubnetId: !Ref SDNPublicSubnetA # Place EC2 in public subnet A

  # Elastic IP for EC2 instance (for public access)
  SDNEC2EIP:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  # Associate Elastic IP with EC2 instance
  SDNEC2EIPAssociation:
    Type: AWS::EC2::EIPAssociation
    Properties:
      InstanceId: !Ref SDNEC2Instance
      EIP: !Ref SDNEC2EIP

  # ECR repository for backend Docker images
  SDNECR:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub sdn-backend-${AWS::AccountId}-${AWS::Region}

  # RDS PostgreSQL instance for backend database
  SDNRDS:
    Type: AWS::RDS::DBInstance
    DependsOn:
      - SDNVPCGatewayAttachment
      - SDNPublicRoute
      - SDNSubnetRouteTableAssociationA
      - SDNSubnetRouteTableAssociationB
      - SDNRDSSubnetGroup
    Properties:
      DBInstanceIdentifier: !Sub sdn-postgres-${AWS::AccountId}-${AWS::Region}
      AllocatedStorage: 20 # GB
      DBInstanceClass: db.t3.micro
      Engine: postgres
      EngineVersion: 17.5 # <-- Use the exact version from the AWS Console
      MasterUsername: masteruser # <-- Change for production
      MasterUserPassword: masterpassword # <-- Use Secrets Manager for production!
      VPCSecurityGroups:
        - !GetAtt SDNRDSSecurityGroup.GroupId
      PubliclyAccessible: true
      BackupRetentionPeriod: 7
      StorageType: gp2
      MultiAZ: false
      DBSubnetGroupName: !Ref SDNRDSSubnetGroup

  # Security group for EC2 instance (allows SSH, HTTPS, HTTP)
  SDNSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Enable HTTPS for users, HTTP for AWS services, and SSH for admins
      VpcId: !Ref SDNVPC
      SecurityGroupIngress:
        # SSH access (restrict in production!)
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        # HTTPS for public users
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0
        # HTTP for CloudFront (allow from anywhere)
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0

  # Security group for RDS instance (allow EC2 access and your IP)
  SDNRDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow EC2 access to RDS
      VpcId: !Ref SDNVPC
      SecurityGroupIngress:
        # Allow EC2 access
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !GetAtt SDNSecurityGroup.GroupId
        # Allow access from your local computer
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: 130.185.237.31/32 # <-- Replace with your actual public IP

  # CloudFront distribution for CDN and custom domain
  SDNCloudFront:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Enabled: true
        DefaultRootObject: index.html
        Origins:
          # S3 origin for static frontend
          - DomainName: !Sub "${SDNBucket}.s3.eu-north-1.amazonaws.com"
            Id: S3Origin
            S3OriginConfig: {}
            OriginAccessControlId: !Ref SDNOAC
          # EC2 origin for backend API
          - DomainName: !GetAtt SDNEC2Instance.PublicDnsName
            Id: ApiOrigin
            CustomOriginConfig:
              HTTPPort: 80
              HTTPSPort: 443
              OriginProtocolPolicy: http-only
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD]
          CachedMethods: [GET, HEAD]
          ForwardedValues:
            QueryString: false
            Cookies:
              Forward: none
          Compress: true # <-- Enable compression here
        CacheBehaviors:
          # Route /api/* requests to backend API (EC2)
          - PathPattern: /api/*
            TargetOriginId: ApiOrigin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [GET, HEAD, OPTIONS, PUT, POST, PATCH, DELETE]
            CachedMethods: [GET, HEAD, OPTIONS]
            ForwardedValues:
              QueryString: true
              Cookies:
                Forward: all
            DefaultTTL: 0
            MinTTL: 0
            MaxTTL: 0
        ViewerCertificate:
          AcmCertificateArn: arn:aws:acm:us-east-1:876528174456:certificate/f87820f7-3923-4a46-9b72-d47885df1b17
          SslSupportMethod: sni-only
        Aliases:
          - secret-domain.net
        CustomErrorResponses:
          - ErrorCode: 404
            ResponsePagePath: /index.html
            ResponseCode: 200
            ErrorCachingMinTTL: 0
          - ErrorCode: 403
            ResponsePagePath: /index.html
            ResponseCode: 200
            ErrorCachingMinTTL: 0

  # ACM certificate for custom domain (must be validated manually in AWS Console)
  SDNCertificate:
    Type: AWS::CertificateManager::Certificate
    Properties:
      DomainName: secret-domain.net
      ValidationMethod: DNS

  # Public route table for the subnet
  SDNPublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref SDNVPC

  # Route to allow internet access from the subnet
  SDNPublicRoute:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref SDNPublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref SDNInternetGateway

  # Associate both public subnets with the public route table
  SDNSubnetRouteTableAssociationA:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SDNPublicSubnetA
      RouteTableId: !Ref SDNPublicRouteTable

  SDNSubnetRouteTableAssociationB:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref SDNPublicSubnetB
      RouteTableId: !Ref SDNPublicRouteTable

  # RDS subnet group for the database
  SDNRDSSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Public subnet group for RDS
      SubnetIds:
        - !Ref SDNPublicSubnetA
        - !Ref SDNPublicSubnetB

  # Bucket policy to allow CloudFront to access S3 bucket (OAC)
  SDNBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref SDNBucket
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Sid: AllowCloudFrontServicePrincipalReadOnly
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub arn:aws:s3:::sdn-frontend-${AWS::AccountId}-${AWS::Region}/*
            Condition:
              StringEquals:
                AWS:SourceArn: arn:aws:cloudfront::876528174456:distribution/E4KCLSTALFBTD

  SDNOAC:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: OAC-SDN
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

Outputs:
  S3BucketName:
    Value: !Ref SDNBucket
    Description: S3 bucket for frontend

  EC2InstanceId:
    Value: !Ref SDNEC2Instance
    Description: EC2 instance for backend

  EC2ElasticIP:
    Value: !Ref SDNEC2EIP
    Description: Elastic IP for EC2 instance

  ECRRepositoryName:
    Value: !Ref SDNECR
    Description: ECR repository for backend Docker images

  CloudFrontDistributionId:
    Value: !Ref SDNCloudFront
    Description: CloudFront distribution for frontend

  RDSInstanceEndpoint:
    Value: !GetAtt SDNRDS.Endpoint.Address
    Description: RDS PostgreSQL endpoint
# How to delete the stack if needed
# aws s3 rm s3://sdn-frontend-876528174456-eu-north-1 --recursive --region eu-north-1
# aws ecr batch-delete-image --repository-name sdn-backend-876528174456-eu-north-1 --image-ids $(aws ecr list-images --repository-name sdn-backend-876528174456-eu-north-1 --query 'imageIds[*]' --output json) --region eu-north-1
# aws rds delete-db-instance --db-instance-identifier sdn-postgres-876528174456-eu-north-1 --region eu-north-1 --skip-final-snapshot
# aws cloudformation delete-stack --stack-name sdn-stack --region eu-north-1
